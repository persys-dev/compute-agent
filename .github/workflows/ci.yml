name: CI

on:
  pull_request:
  push:
    branches:
      - main
      - master
      - work

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint-and-validate:
    name: Lint And Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Go mod download
        run: go mod download

      - name: Verify gofmt
        run: |
          files="$(gofmt -l .)"
          if [ -n "$files" ]; then
            echo "Unformatted files:"
            echo "$files"
            exit 1
          fi

      - name: Verify shell scripts syntax
        run: |
          if find . -type f -name '*.sh' | grep -q .; then
            find . -type f -name '*.sh' -print0 | xargs -0 -n1 bash -n
          fi

      # - name: Run golangci-lint
      #   uses: golangci/golangci-lint-action@v8
      #   with:
      #     version: latest
      #     args: --timeout=5m

  proto-drift-check:
    name: Proto Drift Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends protobuf-compiler libprotobuf-dev
          protoc --version

      - name: Install protobuf generators
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.36.11
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.6.1
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Regenerate proto
        run: make proto

      - name: Verify generated code is committed
        run: git diff --exit-code

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [lint-and-validate, proto-drift-check]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run unit tests with race and coverage
        run: make test-unit

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: unit-coverage
          path: coverage.txt
          if-no-files-found: error

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run end-to-end tests
        run: make test-e2e

  build-binaries:
    name: Build Binaries
    runs-on: ubuntu-latest
    needs: [unit-tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build agent and client
        run: |
          go build -v ./cmd/agent
          go build -v ./examples/client

  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [unit-tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build optimized runtime image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          target: runtime
          push: false
          tags: persys/compute-agent:ci-runtime
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build full runtime image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          target: full-runtime
          push: false
          tags: persys/compute-agent:ci-full-runtime
          cache-from: type=gha
          cache-to: type=gha,mode=max
